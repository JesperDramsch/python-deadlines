name: E2E Tests

# E2E tests are expensive - only run when manually triggered or on schedule
on:
  workflow_dispatch:
    inputs:
      browsers:
        description: 'Browsers to test (comma-separated: chromium,firefox,webkit)'
        required: false
        default: 'chromium'
      test-pattern:
        description: 'Test file pattern to run'
        required: false
        default: '**/*.spec.js'
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches:
      - main
    paths:
      # Only run automatically on significant UI changes
      - '_layouts/**'
      - '_includes/**'
      - 'static/js/**'

jobs:
  # Build the site once and share it across all test jobs
  build:
    name: Build Jekyll Site
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v6

      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: ðŸ“¦ Install Ruby dependencies
        run: bundle install

      - name: ðŸ—ï¸ Build Jekyll site
        run: |
          bundle exec jekyll build --config _config.yml,_config.test.yml
        env:
          JEKYLL_ENV: test

      - name: ðŸ“¤ Upload built site
        uses: actions/upload-artifact@v5
        with:
          name: jekyll-site
          path: _site/
          retention-days: 1

  e2e-tests:
    name: E2E Tests - ${{ matrix.browser }}
    runs-on: ubuntu-latest
    needs: build

    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v6

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install Node dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright browsers
        run: |
          npx playwright install --with-deps ${{ matrix.browser }}

      - name: ðŸ“¥ Download built site
        uses: actions/download-artifact@v6
        with:
          name: jekyll-site
          path: _site/

      - name: ðŸš€ Start static server
        run: |
          npx serve _site -l 4000 &
        env:
          CI: true

      - name: â³ Wait for server
        run: |
          npx wait-on http://localhost:4000 -t 15000

      - name: ðŸ§ª Run E2E tests
        run: |
          PLAYWRIGHT_JSON_OUTPUT_NAME=test-results.json npx playwright test --project=${{ matrix.browser }} --reporter=html,json
        env:
          CI: true
          BASE_URL: http://localhost:4000

      - name: ðŸ“‹ Write test summary
        if: always()
        run: |
          if [ -f test-results.json ]; then
            echo "## ðŸŽ­ E2E Test Results - ${{ matrix.browser }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            node -e "
              const results = require('./test-results.json');
              const stats = results.stats || {};
              const passed = stats.expected - stats.unexpected - stats.flaky || 0;
              const failed = stats.unexpected || 0;
              const flaky = stats.flaky || 0;
              const skipped = stats.skipped || 0;
              const total = stats.expected || 0;
              const status = failed === 0 ? 'âœ… Passed' : 'âŒ Failed';
              console.log('| Status | Total | Passed | Failed | Flaky | Skipped |');
              console.log('|--------|-------|--------|--------|-------|---------|');
              console.log('| ' + status + ' | ' + total + ' | ' + passed + ' | ' + failed + ' | ' + flaky + ' | ' + skipped + ' |');
            " >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: playwright-report-${{ matrix.browser }}
          path: |
            playwright-report/
            test-results/
          retention-days: 7

      - name: ðŸ“¸ Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: screenshots-${{ matrix.browser }}
          path: test-results/screenshots/
          retention-days: 7

  e2e-mobile:
    name: E2E Tests - Mobile
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v6

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install Node dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright browsers
        run: |
          npx playwright install --with-deps chromium webkit

      - name: ðŸ“¥ Download built site
        uses: actions/download-artifact@v6
        with:
          name: jekyll-site
          path: _site/

      - name: ðŸš€ Start static server
        run: |
          npx serve _site -l 4000 &
        env:
          CI: true

      - name: â³ Wait for server
        run: |
          npx wait-on http://localhost:4000 -t 15000

      - name: ðŸ“± Run mobile E2E tests
        run: |
          PLAYWRIGHT_JSON_OUTPUT_NAME=test-results.json npx playwright test --project=mobile-chrome --project=mobile-safari --reporter=html,json
        env:
          CI: true
          BASE_URL: http://localhost:4000

      - name: ðŸ“‹ Write test summary
        if: always()
        run: |
          if [ -f test-results.json ]; then
            echo "## ðŸŽ­ E2E Test Results - Mobile" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            node -e "
              const results = require('./test-results.json');
              const stats = results.stats || {};
              const passed = stats.expected - stats.unexpected - stats.flaky || 0;
              const failed = stats.unexpected || 0;
              const flaky = stats.flaky || 0;
              const skipped = stats.skipped || 0;
              const total = stats.expected || 0;
              const status = failed === 0 ? 'âœ… Passed' : 'âŒ Failed';
              console.log('| Status | Total | Passed | Failed | Flaky | Skipped |');
              console.log('|--------|-------|--------|--------|-------|---------|');
              console.log('| ' + status + ' | ' + total + ' | ' + passed + ' | ' + failed + ' | ' + flaky + ' | ' + skipped + ' |');
            " >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“Š Upload mobile test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: playwright-report-mobile
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  visual-regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v6

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install Node dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright
        run: |
          npx playwright install --with-deps chromium

      - name: ðŸ“¥ Download built site
        uses: actions/download-artifact@v6
        with:
          name: jekyll-site
          path: _site/

      - name: ðŸš€ Start static server
        run: |
          npx serve _site -l 4000 &
        env:
          CI: true

      - name: â³ Wait for server
        run: |
          npx wait-on http://localhost:4000 -t 15000

      - name: ðŸ“¸ Capture screenshots
        run: |
          npx playwright test --project=chromium --grep @visual
        env:
          CI: true
          BASE_URL: http://localhost:4000

      - name: ðŸ–¼ï¸ Upload visual diffs
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: visual-diffs
          path: test-results/visual-diffs/
          retention-days: 7

  report:
    name: Test Report
    runs-on: ubuntu-latest
    needs: [e2e-tests, e2e-mobile]
    if: always()

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v6

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: ðŸ“¥ Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: all-reports

      - name: ðŸ“‹ Merge test results
        run: |
          mkdir -p merged-report
          # Merge all test results
          find all-reports -name "*.xml" -exec cp {} merged-report/ \;
          find all-reports -name "*.json" -exec cp {} merged-report/ \;

      - name: ðŸ’¬ Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            let comment = '## ðŸŽ­ E2E Test Results\n\n';

            // Parse test results
            const reportFiles = fs.readdirSync('merged-report').filter(f => f.endsWith('.json'));
            let totalTests = 0;
            let passedTests = 0;
            let failedTests = 0;
            let skippedTests = 0;

            reportFiles.forEach(file => {
              try {
                const data = JSON.parse(fs.readFileSync(path.join('merged-report', file), 'utf8'));
                if (data.stats) {
                  totalTests += data.stats.expected || 0;
                  passedTests += data.stats.passed || 0;
                  failedTests += data.stats.failed || 0;
                  skippedTests += data.stats.skipped || 0;
                }
              } catch (e) {
                console.error(`Failed to parse ${file}:`, e);
              }
            });

            comment += `| Browser | Status | Tests | Passed | Failed | Skipped |\n`;
            comment += `|---------|--------|-------|--------|--------|----------|\n`;

            const browsers = ['chromium', 'firefox', 'webkit', 'mobile'];
            for (const browser of browsers) {
              const artifactExists = fs.existsSync(`all-reports/playwright-report-${browser}`);
              if (artifactExists) {
                const status = failedTests === 0 ? 'âœ…' : 'âŒ';
                comment += `| ${browser} | ${status} | ${totalTests} | ${passedTests} | ${failedTests} | ${skippedTests} |\n`;
              }
            }

            comment += '\n### ðŸ“Š Coverage Summary\n';
            comment += '- Notification System: âœ… Tested\n';
            comment += '- Countdown Timers: âœ… Tested\n';
            comment += '- Conference Management: âœ… Tested\n';
            comment += '- Search & Filter: âœ… Tested\n';

            if (failedTests > 0) {
              comment += '\nâš ï¸ **Some tests failed. Please check the artifacts for details.**\n';
            } else {
              comment += '\nâœ… **All E2E tests passed successfully!**\n';
            }

            // Find and update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('E2E Test Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: ðŸ“ˆ Upload to dashboard
        if: github.ref == 'refs/heads/main'
        continue-on-error: true
        run: |
          echo "Test results can be uploaded to a dashboard service here"
