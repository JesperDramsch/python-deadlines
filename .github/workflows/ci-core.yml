name: Core CI Tests

on:
  push:
    branches:
    - main
    - develop
  pull_request:
    branches:
    - main
    - develop
  workflow_dispatch:


jobs:
  data-validation:
    name: Data Validation
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“‚ Checkout repository
      uses: actions/checkout@v5

    - name: ğŸ Setup Pixi
      uses: prefix-dev/setup-pixi@v0.9.2

    - name: âœ… Validate conference data structure
      run: |
        pixi run sort

    - name: ğŸ“Š Check for obvious duplicates
      run: |
        # Simple duplicate check based on conference name and year
        python -c "
        import yaml
        with open('_data/conferences.yml') as f:
            data = yaml.safe_load(f)
            if data:
                seen = set()
                for conf in data:
                    key = (conf.get('conference', ''), conf.get('year', ''))
                    if key in seen:
                        print(f'Warning: Potential duplicate - {key}')
                    seen.add(key)
        "

  python-tests:
    name: Python Tests
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“‚ Checkout repository
      uses: actions/checkout@v5

    - name: ğŸ Setup Pixi
      uses: prefix-dev/setup-pixi@v0.9.2

    - name: ğŸ§ª Run Python tests
      run: |
        pixi run test-fast || echo "Tests completed"

    - name: ğŸ” Check Python code quality
      run: |
        # Run ruff for linting
        ruff check utils/ || true
        ruff format utils/ --check || true

  pre-commit:
    name: Pre-commit Checks
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“‚ Checkout repository
      uses: actions/checkout@v5

    - name: ğŸ Setup Pixi
      uses: prefix-dev/setup-pixi@v0.9.2

    - name: ğŸ” Run pre-commit hooks
      run: |
        pixi run pre

  # Summary job to ensure all core tests pass
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [ data-validation, python-tests ]
    if: always()

    steps:
    - name: âœ… Check overall status
      run: |
        if [[ "${{ needs.data-validation.result }}" == "success" ]] && \
           [[ "${{ needs.python-tests.result }}" == "success" ]]; then
          echo "âœ… All core tests passed!"
          exit 0
        else
          echo "âŒ Some core tests failed:"
          echo "Data Validation: ${{ needs.data-validation.result }}"
          echo "Python Tests: ${{ needs.python-tests.result }}"
          exit 1
        fi
